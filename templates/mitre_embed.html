{% extends "base.html" %}

{% block title %}MITRE EMBED Analysis - TARA{% endblock %}

{% block extra_head %}
<style>
    .upload-zone {
        border: 2px dashed var(--bs-border-color);
        border-radius: 0.5rem;
        padding: 3rem 2rem;
        text-align: center;
        transition: all 0.3s ease;
        background: var(--bs-body-bg);
    }
    
    .upload-zone:hover {
        border-color: var(--bs-primary);
        background: var(--bs-primary-bg-subtle);
    }
    
    .upload-zone.dragover {
        border-color: var(--bs-success);
        background: var(--bs-success-bg-subtle);
    }
    
    .file-input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }
    
    .file-selected {
        border-color: var(--bs-success);
        background: var(--bs-success-bg-subtle);
    }
    
    .property-group {
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .quiz-section {
        display: none;
    }
    
    .quiz-section.active {
        display: block;
    }
    
    .progress-indicator {
        height: 4px;
        background: var(--bs-border-color);
        border-radius: 2px;
        overflow: hidden;
    }
    
    .progress-bar {
        height: 100%;
        background: var(--bs-primary);
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold mb-3">
                    <i data-feather="cpu" class="me-2"></i>
                    MITRE EMBED Analysis
                </h1>
                <p class="lead text-muted">
                    Choose your analysis approach: complete the interactive device properties questionnaire or upload your MITRE EMBED JSON file
                </p>
            </div>

            <!-- Method Selection -->
            <div class="row mb-5">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body text-center p-4">
                            <div class="mb-3">
                                <i data-feather="clipboard" class="feature-icon text-primary"></i>
                            </div>
                            <h5 class="card-title">Complete Properties Quiz</h5>
                            <p class="card-text text-muted mb-4">
                                Interactive questionnaire covering all MITRE EMB3D device properties
                            </p>
                            <button type="button" class="btn btn-primary" onclick="selectMethod('quiz')">
                                Start Questionnaire
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body text-center p-4">
                            <div class="mb-3">
                                <i data-feather="upload" class="feature-icon text-success"></i>
                            </div>
                            <h5 class="card-title">Upload MITRE EMBED JSON</h5>
                            <p class="card-text text-muted mb-4">
                                Upload an existing MITRE EMBED assessment JSON file
                            </p>
                            <button type="button" class="btn btn-success" onclick="selectMethod('upload')">
                                Upload JSON File
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Section -->
            <div id="uploadSection" class="card mb-5" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="upload" class="me-2"></i>
                        Upload MITRE EMBED JSON File
                    </h5>
                </div>
                <div class="card-body">
                    <form id="uploadForm" method="POST" action="/analyze_embed" enctype="multipart/form-data">
                        <div class="upload-zone" id="uploadZone">
                            <input type="file" class="file-input" id="embedFile" name="embed_file" accept=".json" required>
                            <div id="uploadText">
                                <i data-feather="upload-cloud" class="mb-3" style="width: 48px; height: 48px;"></i>
                                <h6>Drop your MITRE EMBED JSON file here</h6>
                                <p class="text-muted mb-0">or click to browse files</p>
                                <small class="text-muted">Supported format: .json</small>
                            </div>
                            <div id="fileInfo" style="display: none;">
                                <i data-feather="file-text" class="mb-2 text-success"></i>
                                <p class="mb-0 text-success" id="fileName"></p>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg" disabled id="uploadSubmit">
                                <i data-feather="play" class="me-2"></i>
                                Analyze EMBED File
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Quiz Section -->
            <div id="quizSection" class="card mb-5" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i data-feather="clipboard" class="me-2"></i>
                        MITRE EMBED Properties Assessment
                    </h5>
                    <div class="d-flex align-items-center">
                        <small class="text-muted me-3">Progress: <span id="progressText">0/4</span></small>
                        <div class="progress-indicator" style="width: 100px;">
                            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form id="quizForm" method="POST" action="/analyze_embed">
                        <!-- Hardware Properties -->
                        <div class="quiz-section active" id="hardwareSection">
                            <h6 class="text-primary mb-3">Hardware Properties</h6>
                            <div class="property-group">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-11" id="pid11">
                                            <label class="form-check-label" for="pid11">
                                                <strong>PID-11:</strong> Device includes a microprocessor
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-12" id="pid12">
                                            <label class="form-check-label" for="pid12">
                                                <strong>PID-12:</strong> Device includes Memory/Storage (external to CPU)
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-13" id="pid13">
                                            <label class="form-check-label" for="pid13">
                                                <strong>PID-13:</strong> Device includes firmware/BIOS
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-14" id="pid14">
                                            <label class="form-check-label" for="pid14">
                                                <strong>PID-14:</strong> Device includes hardware security module (HSM)
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-15" id="pid15">
                                            <label class="form-check-label" for="pid15">
                                                <strong>PID-15:</strong> Device includes cryptographic processor
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-16" id="pid16">
                                            <label class="form-check-label" for="pid16">
                                                <strong>PID-16:</strong> Device includes hardware random number generator
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-17" id="pid17">
                                            <label class="form-check-label" for="pid17">
                                                <strong>PID-17:</strong> Device includes tamper detection/response mechanisms
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-18" id="pid18">
                                            <label class="form-check-label" for="pid18">
                                                <strong>PID-18:</strong> Device includes secure boot capabilities
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-19" id="pid19">
                                            <label class="form-check-label" for="pid19">
                                                <strong>PID-19:</strong> Device includes physical interfaces (USB, serial, etc.)
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-110" id="pid110">
                                            <label class="form-check-label" for="pid110">
                                                <strong>PID-110:</strong> Device includes wireless communication hardware
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Software Properties -->
                        <div class="quiz-section" id="systemSoftwareSection">
                            <h6 class="text-primary mb-3">System Software Properties</h6>
                            <div class="property-group">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-21" id="pid21">
                                            <label class="form-check-label" for="pid21">
                                                <strong>PID-21:</strong> Device includes a bootloader
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-22" id="pid22">
                                            <label class="form-check-label" for="pid22">
                                                <strong>PID-22:</strong> Device includes debugging capabilities
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-23" id="pid23">
                                            <label class="form-check-label" for="pid23">
                                                <strong>PID-23:</strong> Device includes operating system
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-24" id="pid24">
                                            <label class="form-check-label" for="pid24">
                                                <strong>PID-24:</strong> Device includes device drivers
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-25" id="pid25">
                                            <label class="form-check-label" for="pid25">
                                                <strong>PID-25:</strong> Device includes system services/daemons
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-26" id="pid26">
                                            <label class="form-check-label" for="pid26">
                                                <strong>PID-26:</strong> Device includes configuration management
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-27" id="pid27">
                                            <label class="form-check-label" for="pid27">
                                                <strong>PID-27:</strong> Device includes logging and monitoring
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-28" id="pid28">
                                            <label class="form-check-label" for="pid28">
                                                <strong>PID-28:</strong> Device includes update/patch mechanisms
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Application Software Properties -->
                        <div class="quiz-section" id="applicationSoftwareSection">
                            <h6 class="text-primary mb-3">Application Software Properties</h6>
                            <div class="property-group">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-31" id="pid31">
                                            <label class="form-check-label" for="pid31">
                                                <strong>PID-31:</strong> Device includes user applications
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-32" id="pid32">
                                            <label class="form-check-label" for="pid32">
                                                <strong>PID-32:</strong> Device includes web interfaces
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-33" id="pid33">
                                            <label class="form-check-label" for="pid33">
                                                <strong>PID-33:</strong> Device includes authentication mechanisms
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-34" id="pid34">
                                            <label class="form-check-label" for="pid34">
                                                <strong>PID-34:</strong> Device includes encryption/decryption capabilities
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-35" id="pid35">
                                            <label class="form-check-label" for="pid35">
                                                <strong>PID-35:</strong> Device includes data storage capabilities
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-36" id="pid36">
                                            <label class="form-check-label" for="pid36">
                                                <strong>PID-36:</strong> Device includes remote access capabilities
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-37" id="pid37">
                                            <label class="form-check-label" for="pid37">
                                                <strong>PID-37:</strong> Device includes API/service interfaces
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-38" id="pid38">
                                            <label class="form-check-label" for="pid38">
                                                <strong>PID-38:</strong> Device includes certificate management
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Network Properties -->
                        <div class="quiz-section" id="networkSection">
                            <h6 class="text-primary mb-3">Network Properties</h6>
                            <div class="property-group">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-41" id="pid41">
                                            <label class="form-check-label" for="pid41">
                                                <strong>PID-41:</strong> Device connects to networks
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-42" id="pid42">
                                            <label class="form-check-label" for="pid42">
                                                <strong>PID-42:</strong> Device supports wireless protocols
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-43" id="pid43">
                                            <label class="form-check-label" for="pid43">
                                                <strong>PID-43:</strong> Device supports wired protocols
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-44" id="pid44">
                                            <label class="form-check-label" for="pid44">
                                                <strong>PID-44:</strong> Device includes network security features
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-45" id="pid45">
                                            <label class="form-check-label" for="pid45">
                                                <strong>PID-45:</strong> Device supports network discovery protocols
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-46" id="pid46">
                                            <label class="form-check-label" for="pid46">
                                                <strong>PID-46:</strong> Device includes firewall capabilities
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-47" id="pid47">
                                            <label class="form-check-label" for="pid47">
                                                <strong>PID-47:</strong> Device supports VPN connections
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="properties" value="PID-48" id="pid48">
                                            <label class="form-check-label" for="pid48">
                                                <strong>PID-48:</strong> Device includes intrusion detection
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary" id="prevBtn" onclick="previousSection()" style="display: none;">
                                <i data-feather="chevron-left" class="me-2"></i>Previous
                            </button>
                            <div class="ms-auto">
                                <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextSection()">
                                    Next<i data-feather="chevron-right" class="ms-2"></i>
                                </button>
                                <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
                                    <i data-feather="play" class="me-2"></i>Generate Analysis
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentSection = 0;
const sections = ['hardwareSection', 'systemSoftwareSection', 'applicationSoftwareSection', 'networkSection'];
const sectionTitles = ['Hardware', 'System Software', 'Application Software', 'Network'];

function selectMethod(method) {
    document.getElementById('uploadSection').style.display = method === 'upload' ? 'block' : 'none';
    document.getElementById('quizSection').style.display = method === 'quiz' ? 'block' : 'none';
    
    if (method === 'quiz') {
        currentSection = 0;
        updateQuizDisplay();
    }
}

function updateQuizDisplay() {
    // Hide all sections
    sections.forEach(section => {
        document.getElementById(section).classList.remove('active');
    });
    
    // Show current section
    document.getElementById(sections[currentSection]).classList.add('active');
    
    // Update progress
    const progress = ((currentSection + 1) / sections.length) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('progressText').textContent = `${currentSection + 1}/${sections.length}`;
    
    // Update navigation buttons
    document.getElementById('prevBtn').style.display = currentSection === 0 ? 'none' : 'inline-block';
    document.getElementById('nextBtn').style.display = currentSection === sections.length - 1 ? 'none' : 'inline-block';
    document.getElementById('submitBtn').style.display = currentSection === sections.length - 1 ? 'inline-block' : 'none';
}

function nextSection() {
    if (currentSection < sections.length - 1) {
        currentSection++;
        updateQuizDisplay();
    }
}

function previousSection() {
    if (currentSection > 0) {
        currentSection--;
        updateQuizDisplay();
    }
}

// File upload handling
document.getElementById('embedFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        document.getElementById('uploadText').style.display = 'none';
        document.getElementById('fileInfo').style.display = 'block';
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('uploadZone').classList.add('file-selected');
        document.getElementById('uploadSubmit').disabled = false;
    } else {
        document.getElementById('uploadText').style.display = 'block';
        document.getElementById('fileInfo').style.display = 'none';
        document.getElementById('uploadZone').classList.remove('file-selected');
        document.getElementById('uploadSubmit').disabled = true;
    }
});

// Drag and drop
const uploadZone = document.getElementById('uploadZone');

uploadZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].type === 'application/json') {
        document.getElementById('embedFile').files = files;
        document.getElementById('embedFile').dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}