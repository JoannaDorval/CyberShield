{% extends "base.html" %}

{% block title %}EMB3D Analysis - TARA{% endblock %}

{% block extra_head %}
<style>
    .upload-zone {
        border: 2px dashed var(--bs-border-color);
        border-radius: 0.5rem;
        padding: 3rem 2rem;
        text-align: center;
        transition: all 0.3s ease;
        background: var(--bs-body-bg);
    }
    
    .upload-zone:hover {
        border-color: var(--bs-primary);
        background: var(--bs-primary-bg-subtle);
    }
    
    .upload-zone.dragover {
        border-color: var(--bs-success);
        background: var(--bs-success-bg-subtle);
    }
    
    .file-input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }
    
    .file-selected {
        border-color: var(--bs-success);
        background: var(--bs-success-bg-subtle);
    }
    
    .upload-progress {
        display: none;
    }
    
    .demo-section {
        background: var(--bs-info-bg-subtle);
        border: 1px solid var(--bs-info-border-subtle);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold mb-3">
                    <i data-feather="cpu" class="me-2"></i>
                    MITRE EMB3D Analysis
                </h1>
                <p class="lead text-muted">
                    Upload EMB3D CSV heatmap or complete the questionnaire for IoT/embedded device security assessment
                </p>
            </div>

            <!-- Demo Section -->
            <div class="demo-section text-center">
                <h5><i data-feather="play-circle" class="me-2"></i>Quick Demo</h5>
                <p class="text-muted mb-3">Try the application instantly with sample data</p>
                <a href="{{ url_for('demo') }}" class="btn btn-info me-2">
                    <i data-feather="zap" class="me-1"></i>Instant Demo
                </a>
                <small class="text-muted d-block mt-2">Sample security camera EMB3D analysis with pre-filled data</small>
            </div>

            <!-- Two-Path Selection -->
            <div class="row mb-5">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i data-feather="settings" class="me-2"></i>
                                Choose Input Method
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="input_type" id="input_csv" value="csv_heatmap" checked>
                                        <label class="form-check-label" for="input_csv">
                                            <strong>Upload CSV Heatmap</strong>
                                            <br><small class="text-muted">EMB3D CSV file exported from MITRE EMB3D website</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="input_type" id="input_questionnaire" value="questionnaire">
                                        <label class="form-check-label" for="input_questionnaire">
                                            <strong>Complete Questionnaire</strong>
                                            <br><small class="text-muted">Answer EMB3D device property questions locally</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CSV Upload Section -->
            <div id="csvUploadSection" class="card mb-5">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="upload" class="me-2"></i>
                        EMB3D CSV Heatmap Upload
                    </h5>
                </div>
                <div class="card-body">
                    <form id="uploadForm" action="{{ url_for('upload_files') }}" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="selected_input_type" id="selected_input_type" value="csv_heatmap">
                        <input type="hidden" name="embed_properties" id="embed_properties" value="">
                        
                        <div class="upload-zone" id="csvUploadZone" style="cursor: pointer; position: relative;">
                            <input type="file" name="embed3d_csv" id="embed3d_csv" class="file-input" accept=".csv" style="position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 1;">
                            <div class="upload-content">
                                <i data-feather="upload-cloud" class="mb-3 text-muted" style="width: 48px; height: 48px;"></i>
                                <h6 class="mb-2">Drop CSV file here or click to browse</h6>
                                <p class="text-muted small mb-0">CSV format from MITRE EMB3D website</p>
                                <p class="text-muted small">Max size: 50MB</p>
                            </div>
                            <div class="file-info mt-2" style="display: none;">
                                <i data-feather="file" class="me-1"></i>
                                <span class="filename"></span>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <strong>Instructions:</strong> Download CSV heatmap from MITRE EMB3D website after completing device assessment
                            </small>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="upload-progress mt-4">
                            <div class="d-flex align-items-center justify-content-center">
                                <div class="spinner-border text-primary me-3" role="status">
                                    <span class="visually-hidden">Processing...</span>
                                </div>
                                <div>
                                    <h6 class="mb-0">Processing EMB3D Analysis...</h6>
                                    <small class="text-muted">Analyzing device properties and generating report</small>
                                </div>
                            </div>
                            <div class="progress mt-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn">
                                <i data-feather="play" class="me-2"></i>
                                Generate EMB3D Report
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Questionnaire Section -->
            <div id="questionnaireSection" class="card mb-5" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="check-square" class="me-2"></i>
                        MITRE EMB3D Device Property Questionnaire
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">Complete the questionnaire by selecting all device properties that apply. Parent properties will reveal relevant sub-properties when selected.</p>
                    
                    <!-- Hardware Properties -->
                    <div class="property-category mb-4">
                        <h6 class="property-category-title text-primary mb-3">
                            <i data-feather="cpu" class="me-2"></i>
                            Hardware Properties
                        </h6>
                        <div class="property-items">
                            <!-- PID-11 -->
                            <div class="property-item mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-11" id="PID-11">
                                    <label class="form-check-label" for="PID-11"><strong>PID-11:</strong> Device includes a microprocessor</label>
                                </div>
                            </div>

                            <!-- PID-12 -->
                            <div class="property-item mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-12" id="PID-12" data-parent>
                                    <label class="form-check-label" for="PID-12"><strong>PID-12:</strong> Device includes Memory/Storage (external to CPU)</label>
                                </div>
                                <div class="property-children ms-4 mt-2" id="children-PID-12" style="display: none;">
                                    <div class="form-check mb-1">
                                        <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-121" id="PID-121" data-child-of="PID-12">
                                        <label class="form-check-label" for="PID-121"><strong>PID-121:</strong> Device includes buses for external memory/storage</label>
                                    </div>
                                    <div class="form-check mb-1">
                                        <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-122" id="PID-122" data-child-of="PID-12">
                                        <label class="form-check-label" for="PID-122"><strong>PID-122:</strong> Device includes discrete chips/devices that have access to the same physical memory</label>
                                    </div>
                                    <div class="form-check mb-1">
                                        <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-123" id="PID-123" data-child-of="PID-12">
                                        <label class="form-check-label" for="PID-123"><strong>PID-123:</strong> Device includes ROM, VRAM, or removable Storage</label>
                                    </div>
                                    <div class="form-check mb-1">
                                        <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-124" id="PID-124" data-child-of="PID-12" data-parent>
                                        <label class="form-check-label" for="PID-124"><strong>PID-124:</strong> Device includes Random Access Memory (RAM) chips</label>
                                    </div>
                                    <div class="property-children ms-4 mt-1" id="children-PID-124" style="display: none;">
                                        <div class="form-check mb-1">
                                            <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-1241" id="PID-1241" data-child-of="PID-124">
                                            <label class="form-check-label" for="PID-1241"><strong>PID-1241:</strong> Device includes DDR DRAM</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- PID-13 -->
                            <div class="property-item mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-13" id="PID-13">
                                    <label class="form-check-label" for="PID-13"><strong>PID-13:</strong> Device includes peripheral chips and integrated data buses</label>
                                </div>
                            </div>

                            <!-- PID-14 -->
                            <div class="property-item mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-14" id="PID-14">
                                    <label class="form-check-label" for="PID-14"><strong>PID-14:</strong> Device includes external peripheral interconnects (e.g., USB, Serial)</label>
                                </div>
                            </div>

                            <!-- PID-15 -->
                            <div class="property-item mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-15" id="PID-15">
                                    <label class="form-check-label" for="PID-15"><strong>PID-15:</strong> Device includes a hardware access port (e.g., UART, JTAG)</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- System Software Properties -->
                    <div class="property-category mb-4">
                        <h6 class="property-category-title text-primary mb-3">
                            <i data-feather="settings" class="me-2"></i>
                            System Software Properties
                        </h6>
                        <div class="property-items">
                            <!-- PID-21 -->
                            <div class="property-item mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-21" id="PID-21">
                                    <label class="form-check-label" for="PID-21"><strong>PID-21:</strong> Device includes a bootloader</label>
                                </div>
                            </div>

                            <!-- PID-22 -->
                            <div class="property-item mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-22" id="PID-22">
                                    <label class="form-check-label" for="PID-22"><strong>PID-22:</strong> Device includes debugging capabilities</label>
                                </div>
                            </div>

                            <!-- PID-23 -->
                            <div class="property-item mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-23" id="PID-23">
                                    <label class="form-check-label" for="PID-23"><strong>PID-23:</strong> Device includes OS/kernel</label>
                                </div>
                            </div>

                            <!-- PID-231 -->
                            <div class="property-item mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-231" id="PID-231">
                                    <label class="form-check-label" for="PID-231"><strong>PID-231:</strong> Device includes an operating system that uses drivers/modules that can be loaded</label>
                                </div>
                            </div>

                            <!-- PID-232 -->
                            <div class="property-item mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-232" id="PID-232" data-parent>
                                    <label class="form-check-label" for="PID-232"><strong>PID-232:</strong> Device includes separate users/processes with access to different OS data or functions</label>
                                </div>
                                <div class="property-children ms-4 mt-2" id="children-PID-232" style="display: none;">
                                    <div class="form-check mb-1">
                                        <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-2321" id="PID-2321" data-child-of="PID-232">
                                        <label class="form-check-label" for="PID-2321"><strong>PID-2321:</strong> Device lacks an access enforcement/privilege mechanism</label>
                                    </div>
                                    <div class="form-check mb-1">
                                        <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-2322" id="PID-2322" data-child-of="PID-232" data-parent>
                                        <label class="form-check-label" for="PID-2322"><strong>PID-2322:</strong> Device deploys an access enforcement/privilege mechanism</label>
                                    </div>
                                    <div class="property-children ms-4 mt-1" id="children-PID-2322" style="display: none;">
                                        <div class="form-check mb-1">
                                            <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-23221" id="PID-23221" data-child-of="PID-2322">
                                            <label class="form-check-label" for="PID-23221"><strong>PID-23221:</strong> Device includes and enforces OS user accounts</label>
                                        </div>
                                        <div class="form-check mb-1">
                                            <input class="form-check-input" type="checkbox" name="embed_properties[]" value="PID-23222" id="PID-23222" data-child-of="PID-2322">
                                            <label class="form-check-label" for="PID-23222"><strong>PID-23222:</strong> Device includes a memory management model, including protections of memory access (read-only, executable, writable)</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional System Software Properties (continue with remaining PIDs) -->
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-outline-secondary" id="clearFormBtn">
                            <i data-feather="refresh-cw" class="me-1"></i>Clear All
                        </button>
                        <button type="button" class="btn btn-success" id="demoDataBtn">
                            <i data-feather="zap" class="me-1"></i>Load Demo Data
                        </button>
                        <button type="button" class="btn btn-primary btn-lg px-4" id="questionnaireSubmitBtn">
                            <i data-feather="play" class="me-2"></i>
                            Generate Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Help Section -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i data-feather="help-circle" class="me-2"></i>
                                How to Use
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary">CSV Heatmap Method</h6>
                                    <ol class="small text-muted">
                                        <li>Visit the MITRE EMB3D website</li>
                                        <li>Complete device assessment questionnaire</li>
                                        <li>Export CSV heatmap file</li>
                                        <li>Upload here for analysis</li>
                                    </ol>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary">Questionnaire Method</h6>
                                    <ol class="small text-muted">
                                        <li>Select device properties that apply</li>
                                        <li>Choose from hardware, software, and networking</li>
                                        <li>Use "Demo Data" for sample selections</li>
                                        <li>Generate comprehensive EMB3D report</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csvRadio = document.getElementById('input_csv');
    const questionnaireRadio = document.getElementById('input_questionnaire');
    const csvSection = document.getElementById('csvUploadSection');
    const questionnaireSection = document.getElementById('questionnaireSection');
    const selectedInputType = document.getElementById('selected_input_type');

    function toggleSections() {
        if (csvRadio.checked) {
            csvSection.style.display = 'block';
            questionnaireSection.style.display = 'none';
            selectedInputType.value = 'csv_heatmap';
        } else {
            csvSection.style.display = 'none';
            questionnaireSection.style.display = 'block';
            selectedInputType.value = 'questionnaire';
        }
    }

    csvRadio.addEventListener('change', toggleSections);
    questionnaireRadio.addEventListener('change', toggleSections);

    // Parent-child relationship handler
    function handleParentChildRelationships() {
        const parentCheckboxes = document.querySelectorAll('input[data-parent]');
        
        parentCheckboxes.forEach(parent => {
            parent.addEventListener('change', function() {
                const parentId = this.id;
                const childrenContainer = document.getElementById(`children-${parentId}`);
                const childCheckboxes = document.querySelectorAll(`input[data-child-of="${parentId}"]`);
                
                if (this.checked) {
                    // Show children
                    if (childrenContainer) {
                        childrenContainer.style.display = 'block';
                    }
                } else {
                    // Hide children and uncheck them
                    if (childrenContainer) {
                        childrenContainer.style.display = 'none';
                    }
                    childCheckboxes.forEach(child => {
                        child.checked = false;
                        // Also handle nested children
                        const nestedChildrenContainer = document.getElementById(`children-${child.id}`);
                        if (nestedChildrenContainer) {
                            nestedChildrenContainer.style.display = 'none';
                            const nestedChildren = document.querySelectorAll(`input[data-child-of="${child.id}"]`);
                            nestedChildren.forEach(nestedChild => nestedChild.checked = false);
                        }
                    });
                }
            });
        });
    }

    // Demo data functionality
    document.getElementById('demoDataBtn').addEventListener('click', function() {
        // Select some sample properties with proper PID values
        document.getElementById('PID-11').checked = true;
        document.getElementById('PID-12').checked = true;
        document.getElementById('PID-121').checked = true;
        document.getElementById('PID-21').checked = true;
        document.getElementById('PID-23').checked = true;
        document.getElementById('PID-232').checked = true;
        document.getElementById('PID-2322').checked = true;
        
        // Trigger parent-child logic for demo data
        const event = new Event('change');
        document.getElementById('PID-12').dispatchEvent(event);
        document.getElementById('PID-232').dispatchEvent(event);
        document.getElementById('PID-2322').dispatchEvent(event);
    });

    // Clear form functionality
    document.getElementById('clearFormBtn').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('#questionnaireSection input[type="checkbox"]');
        checkboxes.forEach(cb => {
            cb.checked = false;
        });
        // Hide all children containers
        const childrenContainers = document.querySelectorAll('.property-children');
        childrenContainers.forEach(container => {
            container.style.display = 'none';
        });
    });

    // Questionnaire submit
    document.getElementById('questionnaireSubmitBtn').addEventListener('click', function() {
        const form = document.getElementById('uploadForm');
        
        // Collect all selected PIDs
        const selectedPIDs = [];
        document.querySelectorAll('input[name="embed_properties[]"]:checked').forEach(cb => {
            selectedPIDs.push(cb.value);
        });

        // Convert to the format expected by the backend
        const properties = {
            selected_pids: selectedPIDs
        };

        document.getElementById('embed_properties').value = JSON.stringify(properties);
        form.submit();
    });

    // Initialize parent-child relationships
    handleParentChildRelationships();

    // File upload handling with drag-and-drop
    const fileInput = document.getElementById('embed3d_csv');
    const uploadZone = document.getElementById('csvUploadZone');
    const fileInfo = uploadZone.querySelector('.file-info');
    const filename = fileInfo.querySelector('.filename');

    // File input change handler
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            const file = this.files[0];
            handleFileSelection(file);
        }
    });

    // Drag and drop handlers
    uploadZone.addEventListener('click', function(e) {
        // Only trigger file input if clicking on the zone, not the hidden input
        if (e.target === uploadZone || uploadZone.contains(e.target)) {
            fileInput.click();
        }
    });

    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        console.log('Files dropped:', files.length, files);
        
        if (files.length > 0) {
            const file = files[0];
            console.log('File name:', file.name, 'Type:', file.type, 'Size:', file.size);
            
            // Check if it's a CSV file (by extension or MIME type)
            const isCSV = file.name.toLowerCase().endsWith('.csv') || 
                         file.type === 'text/csv' || 
                         file.type === 'application/csv';
            
            if (isCSV) {
                console.log('Valid CSV file detected');
                // Try modern DataTransfer approach
                try {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    console.log('File transferred to input:', fileInput.files.length);
                } catch (error) {
                    console.error('DataTransfer failed:', error);
                    // Fallback: store file reference for form submission
                    fileInput.droppedFile = file;
                }
                handleFileSelection(file);
            } else {
                console.log('Invalid file type:', file.name, file.type);
                alert('This application requires CSV files only.\n\nYou uploaded: ' + file.name + '\nFile type: ' + (file.type || 'unknown') + '\n\nPlease:\n• Export CSV from MITRE EMB3D website, or\n• Convert Excel to CSV format, or\n• Use the questionnaire option below');
            }
        }
    });

    function handleFileSelection(file) {
        filename.textContent = file.name;
        fileInfo.style.display = 'block';
        uploadZone.classList.add('file-selected');
        
        // Hide the upload prompt and show file info
        uploadZone.querySelector('.upload-content h6').textContent = 'File ready for upload';
        uploadZone.querySelector('.upload-content').style.opacity = '0.7';
        
        // Remove required attribute from CSV input since file is selected
        fileInput.removeAttribute('required');
        
        console.log('File selected:', file.name, 'Size:', file.size);
    }

    // Progress bar simulation
    const form = document.getElementById('uploadForm');
    const progress = document.querySelector('.upload-progress');
    const progressBar = document.querySelector('.progress-bar');

    form.addEventListener('submit', function(e) {
        console.log('Form submit triggered');
        console.log('File input files:', fileInput.files.length);
        
        // If no files selected via normal input but we have a dropped file
        if (fileInput.files.length === 0 && fileInput.droppedFile) {
            console.log('Using dropped file for submission');
            // Create FormData manually to include dropped file
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('embed3d_csv', fileInput.droppedFile);
            formData.append('selected_input_type', 'csv_heatmap');
            formData.append('embed_properties', '');
            
            progress.style.display = 'block';
            let width = 0;
            const interval = setInterval(function() {
                width += Math.random() * 15;
                if (width >= 90) {
                    clearInterval(interval);
                    width = 90;
                }
                progressBar.style.width = width + '%';
            }, 300);
            
            // Submit via fetch
            fetch(form.action, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    return response.text();
                }
            }).then(html => {
                if (html) {
                    document.body.innerHTML = html;
                }
            }).catch(error => {
                console.error('Upload error:', error);
                alert('Upload failed. Please try again.');
                progress.style.display = 'none';
            });
            
            return false;
        }
        
        // Normal form submission
        progress.style.display = 'block';
        let width = 0;
        const interval = setInterval(function() {
            width += Math.random() * 15;
            if (width >= 90) {
                clearInterval(interval);
                width = 90;
            }
            progressBar.style.width = width + '%';
        }, 300);
    });
});
</script>
{% endblock %}