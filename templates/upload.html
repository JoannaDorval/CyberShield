{% extends "base.html" %}

{% block title %}EMB3D Analysis - TARA{% endblock %}

{% block extra_head %}
<style>
    .upload-zone {
        border: 2px dashed var(--bs-border-color);
        border-radius: 0.5rem;
        padding: 3rem 2rem;
        text-align: center;
        transition: all 0.3s ease;
        background: var(--bs-body-bg);
    }
    
    .upload-zone:hover {
        border-color: var(--bs-primary);
        background: var(--bs-primary-bg-subtle);
    }
    
    .upload-zone.dragover {
        border-color: var(--bs-success);
        background: var(--bs-success-bg-subtle);
    }
    
    .file-input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }
    
    .file-selected {
        border-color: var(--bs-success);
        background: var(--bs-success-bg-subtle);
    }
    
    .upload-progress {
        display: none;
    }
    
    .demo-section {
        background: var(--bs-info-bg-subtle);
        border: 1px solid var(--bs-info-border-subtle);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold mb-3">
                    <i data-feather="cpu" class="me-2"></i>
                    MITRE EMB3D Analysis
                </h1>
                <p class="lead text-muted">
                    Upload EMB3D CSV heatmap or complete the questionnaire for IoT/embedded device security assessment
                </p>
            </div>

            <!-- Demo Section -->
            <div class="demo-section text-center">
                <h5><i data-feather="play-circle" class="me-2"></i>Quick Demo</h5>
                <p class="text-muted mb-3">Try the application instantly with sample data</p>
                <a href="{{ url_for('demo') }}" class="btn btn-info me-2">
                    <i data-feather="zap" class="me-1"></i>Instant Demo
                </a>
                <small class="text-muted d-block mt-2">Sample security camera EMB3D analysis with pre-filled data</small>
            </div>

            <!-- Two-Path Selection -->
            <div class="row mb-5">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i data-feather="settings" class="me-2"></i>
                                Choose Input Method
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="input_type" id="input_csv" value="csv_heatmap" checked>
                                        <label class="form-check-label" for="input_csv">
                                            <strong>Upload CSV Heatmap</strong>
                                            <br><small class="text-muted">EMB3D CSV file exported from MITRE EMB3D website</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="input_type" id="input_questionnaire" value="questionnaire">
                                        <label class="form-check-label" for="input_questionnaire">
                                            <strong>Complete Questionnaire</strong>
                                            <br><small class="text-muted">Answer EMB3D device property questions locally</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CSV Upload Section -->
            <div id="csvUploadSection" class="card mb-5">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="upload" class="me-2"></i>
                        EMB3D CSV Heatmap Upload
                    </h5>
                </div>
                <div class="card-body">
                    <form id="uploadForm" action="{{ url_for('upload_files') }}" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="selected_input_type" id="selected_input_type" value="csv_heatmap">
                        <input type="hidden" name="embed_properties" id="embed_properties" value="">
                        
                        <div class="upload-zone" id="csvUploadZone" style="cursor: pointer; position: relative;">
                            <input type="file" name="embed3d_csv" id="embed3d_csv" class="file-input" accept=".csv" style="position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 1;">
                            <div class="upload-content">
                                <i data-feather="upload-cloud" class="mb-3 text-muted" style="width: 48px; height: 48px;"></i>
                                <h6 class="mb-2">Drop CSV file here or click to browse</h6>
                                <p class="text-muted small mb-0">CSV format from MITRE EMB3D website</p>
                                <p class="text-muted small">Max size: 50MB</p>
                            </div>
                            <div class="file-info mt-2" style="display: none;">
                                <i data-feather="file" class="me-1"></i>
                                <span class="filename"></span>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <strong>Instructions:</strong> Download CSV heatmap from MITRE EMB3D website after completing device assessment
                            </small>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="upload-progress mt-4">
                            <div class="d-flex align-items-center justify-content-center">
                                <div class="spinner-border text-primary me-3" role="status">
                                    <span class="visually-hidden">Processing...</span>
                                </div>
                                <div>
                                    <h6 class="mb-0">Processing EMB3D Analysis...</h6>
                                    <small class="text-muted">Analyzing device properties and generating report</small>
                                </div>
                            </div>
                            <div class="progress mt-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn">
                                <i data-feather="play" class="me-2"></i>
                                Generate EMB3D Report
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Questionnaire Section -->
            <div id="questionnaireSection" class="card mb-5" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="check-square" class="me-2"></i>
                        MITRE EMB3D Device Properties Questionnaire
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">Select all device properties that apply to your IoT/embedded device:</p>
                    
                    <!-- Hardware Properties -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">Hardware Properties</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="embed_hardware[]" value="HW.1" id="hw1">
                                    <label class="form-check-label" for="hw1">
                                        <small><strong>HW.1:</strong> Hardware Debug Features</small>
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="embed_hardware[]" value="HW.2" id="hw2">
                                    <label class="form-check-label" for="hw2">
                                        <small><strong>HW.2:</strong> Secure Boot Capabilities</small>
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="embed_hardware[]" value="HW.3" id="hw3">
                                    <label class="form-check-label" for="hw3">
                                        <small><strong>HW.3:</strong> Cryptographic Hardware</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="embed_hardware[]" value="HW.4" id="hw4">
                                    <label class="form-check-label" for="hw4">
                                        <small><strong>HW.4:</strong> Tamper Detection</small>
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="embed_hardware[]" value="HW.5" id="hw5">
                                    <label class="form-check-label" for="hw5">
                                        <small><strong>HW.5:</strong> Physical Interfaces</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- System Software Properties -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">System Software Properties</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="embed_system_software[]" value="SW.1" id="sw1">
                                    <label class="form-check-label" for="sw1">
                                        <small><strong>SW.1:</strong> Operating System</small>
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="embed_system_software[]" value="SW.2" id="sw2">
                                    <label class="form-check-label" for="sw2">
                                        <small><strong>SW.2:</strong> Update Mechanisms</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="embed_system_software[]" value="SW.3" id="sw3">
                                    <label class="form-check-label" for="sw3">
                                        <small><strong>SW.3:</strong> Access Controls</small>
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="embed_system_software[]" value="SW.4" id="sw4">
                                    <label class="form-check-label" for="sw4">
                                        <small><strong>SW.4:</strong> Logging Capabilities</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Application Software Properties -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">Application Software Properties</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="embed_application_software[]" value="APP.1" id="app1">
                                    <label class="form-check-label" for="app1">
                                        <small><strong>APP.1:</strong> Web Applications</small>
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="embed_application_software[]" value="APP.2" id="app2">
                                    <label class="form-check-label" for="app2">
                                        <small><strong>APP.2:</strong> Mobile Apps</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="embed_application_software[]" value="APP.3" id="app3">
                                    <label class="form-check-label" for="app3">
                                        <small><strong>APP.3:</strong> API Interfaces</small>
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="embed_application_software[]" value="APP.4" id="app4">
                                    <label class="form-check-label" for="app4">
                                        <small><strong>APP.4:</strong> Third-party Components</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Networking Properties -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">Networking Properties</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="embed_networking[]" value="NET.1" id="net1">
                                    <label class="form-check-label" for="net1">
                                        <small><strong>NET.1:</strong> Wireless Communication</small>
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="embed_networking[]" value="NET.2" id="net2">
                                    <label class="form-check-label" for="net2">
                                        <small><strong>NET.2:</strong> Network Services</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="embed_networking[]" value="NET.3" id="net3">
                                    <label class="form-check-label" for="net3">
                                        <small><strong>NET.3:</strong> Encryption Protocols</small>
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="embed_networking[]" value="NET.4" id="net4">
                                    <label class="form-check-label" for="net4">
                                        <small><strong>NET.4:</strong> Cloud Connectivity</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-outline-secondary" id="clearFormBtn">
                            <i data-feather="refresh-cw" class="me-1"></i>Clear All
                        </button>
                        <button type="button" class="btn btn-success" id="demoDataBtn">
                            <i data-feather="zap" class="me-1"></i>Load Demo Data
                        </button>
                        <button type="button" class="btn btn-primary btn-lg px-4" id="questionnaireSubmitBtn">
                            <i data-feather="play" class="me-2"></i>
                            Generate Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Help Section -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i data-feather="help-circle" class="me-2"></i>
                                How to Use
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary">CSV Heatmap Method</h6>
                                    <ol class="small text-muted">
                                        <li>Visit the MITRE EMB3D website</li>
                                        <li>Complete device assessment questionnaire</li>
                                        <li>Export CSV heatmap file</li>
                                        <li>Upload here for analysis</li>
                                    </ol>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary">Questionnaire Method</h6>
                                    <ol class="small text-muted">
                                        <li>Select device properties that apply</li>
                                        <li>Choose from hardware, software, and networking</li>
                                        <li>Use "Demo Data" for sample selections</li>
                                        <li>Generate comprehensive EMB3D report</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csvRadio = document.getElementById('input_csv');
    const questionnaireRadio = document.getElementById('input_questionnaire');
    const csvSection = document.getElementById('csvUploadSection');
    const questionnaireSection = document.getElementById('questionnaireSection');
    const selectedInputType = document.getElementById('selected_input_type');

    function toggleSections() {
        if (csvRadio.checked) {
            csvSection.style.display = 'block';
            questionnaireSection.style.display = 'none';
            selectedInputType.value = 'csv_heatmap';
        } else {
            csvSection.style.display = 'none';
            questionnaireSection.style.display = 'block';
            selectedInputType.value = 'questionnaire';
        }
    }

    csvRadio.addEventListener('change', toggleSections);
    questionnaireRadio.addEventListener('change', toggleSections);

    // Demo data functionality
    document.getElementById('demoDataBtn').addEventListener('click', function() {
        // Select some sample properties
        document.getElementById('hw1').checked = true;
        document.getElementById('hw3').checked = true;
        document.getElementById('sw1').checked = true;
        document.getElementById('sw2').checked = true;
        document.getElementById('app1').checked = true;
        document.getElementById('net1').checked = true;
        document.getElementById('net3').checked = true;
    });

    // Clear form functionality
    document.getElementById('clearFormBtn').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('#questionnaireSection input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
    });

    // Questionnaire submit
    document.getElementById('questionnaireSubmitBtn').addEventListener('click', function() {
        const form = document.getElementById('uploadForm');
        
        // Collect selected properties
        const properties = {
            hardware: [],
            system_software: [],
            application_software: [],
            networking: []
        };

        document.querySelectorAll('input[name="embed_hardware[]"]:checked').forEach(cb => {
            properties.hardware.push(cb.value);
        });
        document.querySelectorAll('input[name="embed_system_software[]"]:checked').forEach(cb => {
            properties.system_software.push(cb.value);
        });
        document.querySelectorAll('input[name="embed_application_software[]"]:checked').forEach(cb => {
            properties.application_software.push(cb.value);
        });
        document.querySelectorAll('input[name="embed_networking[]"]:checked').forEach(cb => {
            properties.networking.push(cb.value);
        });

        document.getElementById('embed_properties').value = JSON.stringify(properties);
        form.submit();
    });

    // File upload handling with drag-and-drop
    const fileInput = document.getElementById('embed3d_csv');
    const uploadZone = document.getElementById('csvUploadZone');
    const fileInfo = uploadZone.querySelector('.file-info');
    const filename = fileInfo.querySelector('.filename');

    // File input change handler
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            const file = this.files[0];
            handleFileSelection(file);
        }
    });

    // Drag and drop handlers
    uploadZone.addEventListener('click', function(e) {
        // Only trigger file input if clicking on the zone, not the hidden input
        if (e.target === uploadZone || uploadZone.contains(e.target)) {
            fileInput.click();
        }
    });

    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (file.name.toLowerCase().endsWith('.csv')) {
                // Use DataTransfer to properly set files
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                handleFileSelection(file);
            } else {
                alert('Please select a CSV file');
            }
        }
    });

    function handleFileSelection(file) {
        filename.textContent = file.name;
        fileInfo.style.display = 'block';
        uploadZone.classList.add('file-selected');
        
        // Hide the upload prompt and show file info
        uploadZone.querySelector('.upload-content h6').textContent = 'File ready for upload';
        uploadZone.querySelector('.upload-content').style.opacity = '0.7';
        
        // Remove required attribute from CSV input since file is selected
        fileInput.removeAttribute('required');
        
        console.log('File selected:', file.name, 'Size:', file.size);
    }

    // Progress bar simulation
    const form = document.getElementById('uploadForm');
    const progress = document.querySelector('.upload-progress');
    const progressBar = document.querySelector('.progress-bar');

    form.addEventListener('submit', function() {
        progress.style.display = 'block';
        let width = 0;
        const interval = setInterval(function() {
            width += Math.random() * 15;
            if (width >= 90) {
                clearInterval(interval);
                width = 90;
            }
            progressBar.style.width = width + '%';
        }, 300);
    });
});
</script>
{% endblock %}